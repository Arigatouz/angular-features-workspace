<div class="image-editing-container">
  <div class="main-content">
    <!-- Header -->
    <div class="header-section">
      <h1 class="page-title">
        <mat-icon class="title-icon">photo_camera</mat-icon>
        AI Image Editing
      </h1>
      <p class="page-description">
        Upload and edit images using Google's advanced AI. Add elements, change backgrounds, apply styles, and create stunning modifications.
      </p>
    </div>

    <!-- Image Upload Section -->
    <mat-card class="upload-card">
      <mat-card-header>
        <mat-card-title>Upload Image</mat-card-title>
        <mat-card-subtitle>Select an image to edit</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="upload-section">
          <!-- File Upload Area -->
          <div
            class="image-drop-area"
            [class.dragging]="isDragging()"
            [class.has-image]="selectedFile() !== null"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="fileInput.click()"
          >
            <input
              #fileInput
              type="file"
              accept="image/png,image/jpeg,image/jpg,image/webp,image/gif"
              (change)="onFileSelect($event)"
              style="display: none;"
            >

            @if (selectedFile() === null) {
              <div class="drop-content">
                <mat-icon class="drop-icon">cloud_upload</mat-icon>
                <p class="drop-text">Drag & drop an image here or click to browse</p>
                <small class="drop-hint">Supports PNG, JPG, JPEG, WebP, GIF</small>
              </div>
            } @else {
              <div class="image-preview">
                <img
                  #originalImage
                  [src]="originalImageUrl()"
                  [alt]="selectedFile()!.name"
                  class="preview-image"
                >
                <div class="image-info">
                  <span class="image-name">{{ selectedFile()!.name }}</span>
                  <small class="image-size">{{ getFileSize(selectedFile()!) }}</small>
                </div>
                <button
                  type="button"
                  mat-icon-button
                  (click)="clearSelectedFile(); $event.stopPropagation()"
                  class="remove-image-btn"
                  matTooltip="Remove image"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            }
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Editing Section -->
    @if (selectedFile() !== null) {
      <mat-card class="editing-card">
        <mat-card-header>
          <mat-card-title>Edit Image</mat-card-title>
          <mat-card-subtitle>Describe the changes you want to make</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="editForm" (ngSubmit)="editImage()" class="editing-form">

            <!-- Prompt Suggestions -->
            <div class="prompt-suggestions">
              <p class="suggestions-label">Quick suggestions:</p>
              <div class="suggestions-chips">
                @for (suggestion of promptSuggestions; track suggestion) {
                  <mat-chip (click)="useSuggestion(suggestion)" class="suggestion-chip">
                    {{ suggestion }}
                  </mat-chip>
                }
              </div>
            </div>

            <!-- Editing Prompt -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Editing Prompt</mat-label>
              <textarea
                matInput
                formControlName="prompt"
                placeholder="Describe how you want to modify the image... (Ctrl+Enter to edit)"
                rows="3"
                (keydown)="onKeyDown($event)"
                cdkTextareaAutosize
                cdkAutosizeMinRows="3"
                cdkAutosizeMaxRows="6"
              ></textarea>
              <mat-icon matSuffix>edit</mat-icon>
              @if (editForm.get('prompt')?.invalid && editForm.get('prompt')?.touched) {
                <mat-error>
                  @if (editForm.get('prompt')?.errors?.['required']) {
                    Editing prompt is required
                  }
                  @if (editForm.get('prompt')?.errors?.['minlength']) {
                    Prompt must be at least 5 characters long
                  }
                </mat-error>
              }
            </mat-form-field>

            <!-- Edit Buttons -->
            <div class="form-buttons">
              <button
                mat-raised-button
                color="accent"
                type="submit"
                class="edit-btn"
                style="display: flex; align-items: center; justify-content: center; gap: 8px;"
              >
                @if (isProcessing()) {
                  <mat-icon>hourglass_empty</mat-icon>
                  Processing...
                } @else {
                  <mat-icon>auto_fix_high</mat-icon>
                  Edit Image
                }
              </button>

              @if (isProcessing()) {
                <button mat-stroked-button type="button" (click)="stop()" class="stop-btn">
                  <mat-icon>stop</mat-icon>
                  Stop
                </button>
              }

              @if (hasResults()) {
                <button mat-stroked-button type="button" (click)="downloadCurrentResult()" class="download-btn">
                  <mat-icon>download</mat-icon>
                  Download Result
                </button>
              }
            </div>

            <!-- Progress Bar -->
            @if (isProcessing()) {
              <mat-progress-bar mode="indeterminate" class="progress-bar"></mat-progress-bar>
            }
          </form>
        </mat-card-content>
      </mat-card>
    }

    <!-- Results Section -->
    @if (hasResults()) {
      <mat-card class="results-card">
        <mat-card-header>
          <mat-card-title>Results</mat-card-title>
          <mat-card-subtitle>Original vs Edited</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="results-comparison">
            <div class="result-item">
              <h3>Original</h3>
              <div class="result-image-container">
                <img
                  [src]="originalImageUrl()"
                  alt="Original image"
                  class="result-image"
                >
              </div>
            </div>

            <div class="result-divider">
              <mat-icon>arrow_forward</mat-icon>
            </div>

            <div class="result-item">
              <h3>Edited</h3>
              <div class="result-image-container">
                <img
                  #editedImage
                  [src]="editedImageUrl()"
                  alt="Edited image"
                  class="result-image"
                >
              </div>
            </div>
          </div>

          <div class="result-info">
            <p class="result-prompt">
              <strong>Prompt:</strong> {{ currentEditingResult()?.prompt }}
            </p>
            <div class="result-actions">
              <button mat-raised-button color="primary" (click)="downloadCurrentResult()">
                <mat-icon>download</mat-icon>
                Download Edited Image
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }

    <!-- Error Display -->
    @if (serviceError() || error()) {
      <mat-card class="error-card">
        <mat-card-content>
          <div class="error-content">
            <mat-icon class="error-icon">error</mat-icon>
            <div class="error-details">
              <h4>Processing Error</h4>
              <p>{{ (serviceError() || error())?.message }}</p>
              @if ((serviceError() || error())?.type === 'API_KEY_MISSING') {
                <button mat-stroked-button color="primary" (click)="showApiKeyModal()">
                  <mat-icon>key</mat-icon>
                  Configure API Key
                </button>
              }
            </div>
            <button mat-icon-button (click)="dismissError()" class="dismiss-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- History Sidebar -->
  <div class="sidebar">
    <mat-card class="history-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Editing History
          @if (totalEditedImages() > 0) {
            <mat-chip-set>
              <mat-chip>{{ totalEditedImages() }}</mat-chip>
            </mat-chip-set>
          }
        </mat-card-title>
        <mat-card-subtitle>Previous image edits</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        @if (editingHistory().length === 0) {
          <div class="empty-state">
            <mat-icon class="empty-icon">photo_camera</mat-icon>
            <p>No edits yet</p>
            <small>Upload an image and create your first edit to see results here</small>
          </div>
        } @else {
          <div class="history-list" #historyContainer>
            @for (editedImage of editingHistory(); track $index) {
              <div class="history-item">
                <div class="history-header">
                  <div class="history-images">
                    <img
                      [src]="'data:' + editedImage.mimeType + ';base64,' + editedImage.originalImageData"
                      alt="Original"
                      class="history-thumbnail original"
                    >
                    <mat-icon class="history-arrow">arrow_forward</mat-icon>
                    <img
                      [src]="'data:' + editedImage.mimeType + ';base64,' + editedImage.editedImageData"
                      alt="Edited"
                      class="history-thumbnail edited"
                    >
                  </div>
                  <div class="history-meta">
                    <span class="history-prompt">{{ editedImage.prompt | slice:0:40 }}{{ editedImage.prompt.length > 40 ? '...' : '' }}</span>
                    <small class="history-time">{{ editedImage.timestamp | date:'short' }}</small>
                    <small class="history-filename">{{ editedImage.originalFileName }}</small>
                  </div>
                </div>

                <div class="history-actions">
                  <button mat-icon-button (click)="viewImageFromHistory(editedImage)" matTooltip="View">
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button mat-icon-button (click)="downloadFromHistory(editedImage)" matTooltip="Download">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button mat-icon-button (click)="removeFromHistory($index)" matTooltip="Remove" class="remove-btn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              @if ($index < editingHistory().length - 1) {
                <mat-divider class="history-divider"></mat-divider>
              }
            }
          </div>

          <div class="history-actions-footer">
            <button mat-stroked-button (click)="clearEditingHistory()" color="warn">
              <mat-icon>clear_all</mat-icon>
              Clear History
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Stats Card -->
    <mat-card class="stats-card">
      <mat-card-content>
        <div class="stat-item">
          <mat-icon>photo_camera</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ totalEditedImages() }}</span>
            <span class="stat-label">Images Edited</span>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon>auto_fix_high</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ hasResults() ? 'Active' : 'Ready' }}</span>
            <span class="stat-label">Editing Status</span>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon>verified</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ getApiKeyStatus() }}</span>
            <span class="stat-label">API Status</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
