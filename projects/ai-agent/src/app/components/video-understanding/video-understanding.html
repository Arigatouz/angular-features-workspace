<div class="video-understanding-container">
  <div class="main-content">
    <!-- Header -->
    <div class="header-section">
      <h1 class="page-title">
        <mat-icon class="title-icon">smart_display</mat-icon>
        Video Understanding
      </h1>
      <p class="page-description">
        Analyze and understand YouTube videos using Google's advanced AI vision models. Get summaries, insights, and answers about video content.
      </p>
    </div>

    <!-- Analysis Form -->
    <mat-card class="analysis-form-card">
      <mat-card-header>
        <mat-card-title>Analyze Video</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="form" (ngSubmit)="analyzeVideo()" class="analysis-form">

          <!-- YouTube URL Input -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>YouTube Video URL</mat-label>
            <input
              matInput
              formControlName="videoUrl"
              placeholder="https://www.youtube.com/watch?v=..."
              (keydown)="onKeyDown($event)"
            />
            <mat-icon matSuffix>link</mat-icon>
            @if (form.get('videoUrl')?.invalid && form.get('videoUrl')?.touched) {
              <mat-error>
                @if (form.get('videoUrl')?.errors?.['required']) {
                  YouTube URL is required
                }
                @if (form.get('videoUrl')?.errors?.['invalidYouTubeUrl']) {
                  Please enter a valid YouTube URL
                }
              </mat-error>
            }
          </mat-form-field>

          <!-- Video Preview -->
          @if (form.get('videoUrl')?.valid && form.get('videoUrl')?.value) {
            <div class="video-preview">
              <img [src]="getThumbnailUrl(form.get('videoUrl')!.value)"
                   alt="Video thumbnail"
                   class="video-thumbnail"
                   (error)="$event.target.style.display='none'">
              <div class="video-info">
                <p><strong>Video ID:</strong> {{ getVideoId(form.get('videoUrl')!.value) }}</p>
                <button mat-stroked-button type="button" (click)="openVideoInNewTab(form.get('videoUrl')!.value)">
                  <mat-icon>open_in_new</mat-icon>
                  Open Video
                </button>
              </div>
            </div>
          }

          <!-- Prompt Template Selection -->
          <mat-form-field appearance="outline" class="template-select">
            <mat-label>Analysis Type</mat-label>
            <mat-select formControlName="promptTemplate" (selectionChange)="onPromptTemplateChange()">
              @for (template of promptTemplates; track template.id) {
                <mat-option [value]="template.id">{{ template.label }}</mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>category</mat-icon>
          </mat-form-field>

          <!-- Custom Prompt Input -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Analysis Prompt</mat-label>
            <textarea
              matInput
              formControlName="customPrompt"
              placeholder="What would you like to know about this video?"
              rows="3"
              cdkTextareaAutosize
              cdkAutosizeMinRows="2"
              cdkAutosizeMaxRows="6"
            ></textarea>
            <mat-icon matSuffix>question_answer</mat-icon>
            @if (selectedTemplate()?.id === 'custom') {
              <mat-hint>Enter your custom analysis prompt</mat-hint>
            } @else {
              <mat-hint>You can modify the template prompt above</mat-hint>
            }
          </mat-form-field>

          <!-- Model Selection -->
          <mat-form-field appearance="outline" class="model-select">
            <mat-label>AI Model</mat-label>
            <mat-select formControlName="model">
              @for (model of modelOptions; track model.id) {
                <mat-option [value]="model.id">{{ model.label }}</mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>psychology</mat-icon>
          </mat-form-field>

          <!-- Control Buttons -->
          <div class="form-buttons">
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="form.invalid || isServiceGenerating() || !isServiceInitialized()"
              class="analyze-btn"
            >
              @if (isServiceGenerating()) {
                <mat-icon>hourglass_empty</mat-icon>
                Analyzing...
              } @else {
                <mat-icon>play_arrow</mat-icon>
                Analyze Video
              }
            </button>

            @if (isServiceGenerating()) {
              <button mat-stroked-button type="button" (click)="stop()" class="stop-btn">
                <mat-icon>stop</mat-icon>
                Stop
              </button>
            }

            <button mat-stroked-button type="button" (click)="clearUrl()">
              <mat-icon>clear</mat-icon>
              Clear URL
            </button>
          </div>

          <!-- Progress Bar -->
          @if (isServiceGenerating()) {
            <mat-progress-bar mode="indeterminate" class="progress-bar"></mat-progress-bar>
          }
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Error Display -->
    @if (serviceError() || error()) {
      <mat-card class="error-card">
        <mat-card-content>
          <div class="error-content">
            <mat-icon class="error-icon">error</mat-icon>
            <div class="error-details">
              <h4>Analysis Error</h4>
              <p>{{ (serviceError() || error())?.message }}</p>
              @if ((serviceError() || error())?.type === 'API_KEY_MISSING') {
                <button mat-stroked-button color="primary" (click)="showApiKeyModal()">
                  <mat-icon>key</mat-icon>
                  Configure API Key
                </button>
              }
            </div>
            <button mat-icon-button (click)="dismissError()" class="dismiss-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- Analysis History Sidebar -->
  <div class="sidebar">
    <mat-card class="history-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Analysis History
          @if (totalAnalyzedVideos() > 0) {
            <mat-chip-set>
              <mat-chip>{{ totalAnalyzedVideos() }}</mat-chip>
            </mat-chip-set>
          }
        </mat-card-title>
        <mat-card-subtitle>Recently analyzed videos</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        @if (analyzedVideos().length === 0) {
          <div class="empty-state">
            <mat-icon class="empty-icon">smart_display</mat-icon>
            <p>No videos analyzed yet</p>
            <small>Analyze your first video to see results here</small>
          </div>
        } @else {
          <div class="analysis-list" #analysisHistoryContainer>
            @for (analysis of analyzedVideos(); track $index) {
              <div class="analysis-item">
                <div class="analysis-header">
                  <div class="video-thumbnail-small">
                    <img [src]="getThumbnailUrl(analysis.videoUrl)"
                         alt="Video thumbnail"
                         (error)="$event.target.style.display='none'">
                  </div>
                  <div class="analysis-meta">
                    <span class="analysis-model">{{ analysis.model }}</span>
                    <small class="analysis-time">{{ analysis.timestamp | date:'short' }}</small>
                  </div>
                  <button mat-icon-button [matMenuTriggerFor]="analysisMenu" class="analysis-menu-btn">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #analysisMenu="matMenu">
                    <button mat-menu-item (click)="copyAnalysis(analysis.analysis)">
                      <mat-icon>content_copy</mat-icon>
                      Copy Analysis
                    </button>
                    <button mat-menu-item (click)="copyVideoUrl(analysis.videoUrl)">
                      <mat-icon>link</mat-icon>
                      Copy Video URL
                    </button>
                    <button mat-menu-item (click)="openVideoInNewTab(analysis.videoUrl)">
                      <mat-icon>open_in_new</mat-icon>
                      Open Video
                    </button>
                    <button mat-menu-item (click)="removeAnalysis($index)">
                      <mat-icon>delete</mat-icon>
                      Remove
                    </button>
                  </mat-menu>
                </div>

                <div class="analysis-prompt">
                  <strong>Prompt:</strong> {{ analysis.prompt }}
                </div>

                <div class="analysis-result">
                  <div [innerHTML]="analysis.analysis | markdown"></div>
                </div>

                <div class="analysis-actions">
                  <button mat-stroked-button (click)="copyAnalysis(analysis.analysis)" class="copy-btn">
                    <mat-icon>content_copy</mat-icon>
                    Copy
                  </button>
                  <button mat-stroked-button (click)="openVideoInNewTab(analysis.videoUrl)" class="watch-btn">
                    <mat-icon>play_arrow</mat-icon>
                    Watch
                  </button>
                </div>
              </div>

              @if ($index < analyzedVideos().length - 1) {
                <mat-divider></mat-divider>
              }
            }
          </div>

          <div class="history-actions">
            <button mat-stroked-button (click)="clearAllAnalyses()" color="warn">
              <mat-icon>clear_all</mat-icon>
              Clear All
            </button>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Stats Card -->
    <mat-card class="stats-card">
      <mat-card-content>
        <div class="stat-item">
          <mat-icon>smart_display</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ totalAnalyzedVideos() }}</span>
            <span class="stat-label">Videos Analyzed</span>
          </div>
        </div>

        <div class="stat-item">
          <mat-icon>verified</mat-icon>
          <div class="stat-content">
            <span class="stat-value">{{ getApiKeyStatus() }}</span>
            <span class="stat-label">API Status</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>